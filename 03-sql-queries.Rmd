
```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(eval = FALSE)
```

# Accessing Database

## Duckplyr

If you are new to database queries but familiar with dplyr and tidyverse, I recommend using `duckplyr`. You can find more information about `duckplyr` [here](https://duckdb.org/2024/04/02/duckplyr.html) but the main takeaway is that you can query your database using dplyr phrases and pipes, while also saving memory on loading data.

```{r}
library(celltracktech)
library(duckplyr)

# load base tables
raw = tbl(conn, 'raw') |> as_duckdb_tibble()
blu = tbl(conn, 'blu') |> as_duckdb_tibble()
gps = tbl(conn, "gps") |> as_duckdb_tibble()
node_health = tbl(conn, 'node_health') |> as_duckdb_tibble()

# load node tables
node_raw = tbl(conn, 'node_raw') |> as_duckdb_tibble()
node_blu = tbl(conn, 'node_blu') |> as_duckdb_tibble()
node_gps = tbl(conn, 'node_gps') |> as_duckdb_tibble()
node_health_from_node = tbl(conn, 'node_health_from_node') |> as_duckdb_tibble()
```
## SQL Queries

If you are more comfortable with the SQL syntax, you can use SQL queries to get data from different tables.

This chapter is a quick summary on how to use SQL in R. If you would like more info on how to run different queries, use this tutorial: [https://solutions.posit.co/connections/db/getting-started/database-queries/](https://solutions.posit.co/connections/db/getting-started/database-queries/) 

## List Tables

List the tables in your database. If everything was run correctly, each data file type (raw, blu, node-health, etc.) should be in its own data table.

Remember to reconnect to the database!

```{r}
library(celltracktech)

con <- DBI::dbConnect(duckdb::duckdb(), 
                      dbdir = "./data/Meadows V2/meadows.duckdb", 
                      read_only = FALSE)

# list tables in database
DBI::dbListTables(con)

# disconnect from database
DBI::dbDisconnect(con)

```
## Load each data table into RStudio

```{r}
# connect to database
con <- DBI::dbConnect(duckdb::duckdb(), 
                      dbdir = "./data/Meadows V2/meadows.duckdb", 
                      read_only = FALSE)

# list last 10 records in raw
raw = DBI::dbGetQuery(con, "SELECT * FROM raw "); raw
tail(raw)

# list last 10 records in blu
blu = DBI::dbGetQuery(con, "SELECT * FROM blu "); blu
tail(blu)
head(blu)

# list the number of unique nodes in your project
node_table = DBI::dbGetQuery(con, 'SELECT * FROM nodes')
head(node_table)

# list the data files that were used to create your database
df_table = DBI::dbGetQuery(con, 'SELECT * FROM data_file')

DBI::dbDisconnect(con)

```
Find unique tags
```{r}
unique_tags = raw %>%
  group_by(tag_id) %>%
  summarize(num_detect = n()) %>%
  select(tag_id, num_detect) %>%
  arrange(desc(num_detect))
```
Note: you do not need to load each table into RStudio. You should only load the tables you need to for your analysis.